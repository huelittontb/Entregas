name: Build APK (Kivy + Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Clonando repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ³ Preparando container Buildozer
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: -v ${{ github.workspace }}:/home/user/app
          run: |
            echo "âš™ï¸ Limpando build anterior..."
            cd /home/user/app
            rm -rf .buildozer bin || true

            echo "â¬‡ï¸ Instalando dependÃªncias..."
            pip install --upgrade pip buildozer

            echo "ğŸ©¹ Ignorando check_root()..."
            BUILD_PATH=$(python3 -c "import buildozer, os; print(os.path.dirname(buildozer.__file__))")
            sed -i '/def check_root(self):/a\        return' "$BUILD_PATH/__init__.py"

            echo "ğŸ“¦ Configurando SDK e variÃ¡veis..."
            export ANDROID_SDK_ROOT=/root/android-sdk
            export ANDROID_NDK_HOME=/root/android-ndk
            export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH

            echo "â¬‡ï¸ Instalando dependÃªncias do sistema..."
            apt-get update -qq
            apt-get install -y wget unzip openjdk-17-jdk

            echo "ğŸ“¥ Instalando Android Command Line Tools..."
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
            cd $ANDROID_SDK_ROOT/cmdline-tools
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
            unzip -q tools.zip
            mv cmdline-tools latest
            rm tools.zip
            cd /home/user/app

            echo "âœ… Aceitando todas as licenÃ§as..."
            yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true

            echo "â¬‡ï¸ Instalando componentes do SDK..."
            yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
              "platform-tools" \
              "platforms;android-35" \
              "build-tools;35.0.0" \
              "ndk;25.1.8937393" \
              "cmdline-tools;latest"

            echo "ğŸ”§ Configurando Buildozer para usar o SDK correto..."
            mkdir -p .buildozer/android/platform
            ln -sfn $ANDROID_SDK_ROOT .buildozer/android/platform/android-sdk
            ln -sfn $ANDROID_NDK_HOME .buildozer/android/platform/android-ndk-r25b

            echo "ğŸš€ Compilando APK..."
            buildozer -v android debug | tee buildozer.log || (echo "âŒ Falha na compilaÃ§Ã£o"; exit 1)

            echo "ğŸ“¦ Procurando APK gerado..."
            mkdir -p bin || true
            APK_PATH=$(find . -name "*.apk" | head -n 1)
            if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" bin/app-release.apk
              echo "âœ… APK gerado com sucesso em: bin/app-release.apk"
            else
              echo "âŒ Nenhum APK encontrado!"
              exit 1
            fi

      - name: ğŸ’¾ Salvando buildozer.log
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer.log

      - name: ğŸ“± Publicando APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: bin/app-release.apk
