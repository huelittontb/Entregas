name: Build APK (Kivy + Buildozer)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: âš¡ Cache Buildozer & Gradle
        uses: actions/cache@v4
        with:
          path: |
            .buildozer
            ~/.buildozer
            ~/.gradle
          key: buildozer-${{ runner.os }}-${{ hashFiles('**/buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: ğŸ³ Build APK no container Buildozer
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: -v ${{ github.workspace }}:/home/user/app -w /home/user/app --user root
          run: |
            echo "âš™ï¸ Limpando build anterior..."
            rm -rf .buildozer bin || true

            echo "â¬‡ï¸ Instalando dependÃªncias..."
            pip install --upgrade pip buildozer

            echo "ğŸ©¹ Aplicando patch para ignorar check_root()..."
            BUILD_PATH=$(python3 -c "import buildozer, os; print(os.path.dirname(buildozer.__file__))")
            sed -i '/def check_root(self):/a\        return' "$BUILD_PATH/__init__.py"

            echo "ğŸš€ Compilando APK..."
            buildozer -v android debug || (echo "âŒ Falha na compilaÃ§Ã£o"; exit 1)

            echo "ğŸ“¦ Procurando APK gerado..."
            mkdir -p bin || true
            APK_PATH=$(find . -name "*.apk" | head -n 1)
            if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" bin/app-release.apk
              echo "âœ… APK gerado em: bin/app-release.apk"
            else
              echo "âŒ Nenhum APK encontrado!"
              exit 1
            fi

      - name: ğŸ“¤ Upload do APK como artefato
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: bin/app-release.apk

      - name: ğŸ·ï¸ Publicar Release automÃ¡tica
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "build-${{ github.run_number }}"
          name: "Build #${{ github.run_number }}"
          files: bin/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
