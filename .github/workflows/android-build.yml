name: Build APK (Kivy + Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üß± Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üê≥ Build APK com Buildozer
        uses: addnab/docker-run-action@v3
        with:
          image: kivy/buildozer:latest
          options: -v ${{ github.workspace }}:/home/user/app -w /home/user/app --user root
          run: |
            echo "‚öôÔ∏è Limpando build anterior..."
            rm -rf .buildozer bin || true

            echo "‚¨áÔ∏è Instalando depend√™ncias..."
            pip install --upgrade pip buildozer

            echo "ü©π Aplicando patch para ignorar check_root()..."
            BUILD_PATH=$(python3 -c "import buildozer, os; print(os.path.dirname(buildozer.__file__))")
            sed -i '/def check_root(self):/a\        return' "$BUILD_PATH/__init__.py"

            echo "üì¶ Configurando SDK e aceitando licen√ßas..."
            export ANDROID_SDK_ROOT=/root/.buildozer/android/platform/android-sdk
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest/bin
            export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools

            echo "‚¨áÔ∏è Instalando ferramentas do SDK (sdkmanager, platform-tools, build-tools)..."
            apt-get update -qq
            apt-get install -y unzip wget openjdk-17-jdk

            # Instalar manualmente o commandlinetools (sdkmanager)
            mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
            cd $ANDROID_SDK_ROOT/cmdline-tools
            wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
            unzip -q tools.zip
            mv cmdline-tools latest
            rm tools.zip
            cd /home/user/app

            echo "‚úÖ Aceitando licen√ßas..."
            yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true

            echo "üì¶ Instalando pacotes essenciais..."
            yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
              "platform-tools" \
              "platforms;android-36" \
              "build-tools;36.1.0" \
              "cmdline-tools;latest" \
              "ndk;25.1.8937393"

            echo "üöÄ Compilando APK..."
            buildozer -v android debug || (echo "‚ùå Falha na compila√ß√£o"; exit 1)

            echo "üì¶ Procurando APK gerado..."
            mkdir -p bin || true
            APK_PATH=$(find . -name "*.apk" | head -n 1)
            if [ -f "$APK_PATH" ]; then
              cp "$APK_PATH" bin/app-release.apk
              echo "‚úÖ APK gerado em: bin/app-release.apk"
            else
              echo "‚ùå Nenhum APK encontrado!"
              exit 1
            fi

      - name: üì§ Upload do APK como artefato
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: bin/app-release.apk
